# InstaCure Architecture - Visual Guide

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INSTACURE SYSTEM                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React/TypeScript)                 â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  EmergencyPage   â”‚  â”‚  VitalMonitor    â”‚  â”‚  PatientProfileâ”‚   â”‚
â”‚  â”‚  - Display Data  â”‚  â”‚  - Live Display  â”‚  â”‚  - Edit Info   â”‚   â”‚
â”‚  â”‚  - QR Scanner    â”‚  â”‚  - Status Alerts â”‚  â”‚  - Manage Meds â”‚   â”‚
â”‚  â”‚  - Maps          â”‚  â”‚  - Collapsible   â”‚  â”‚  - History     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                     â”‚                     â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                 â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             Emergency API Client                           â”‚   â”‚
â”‚  â”‚  - getEmergencyView(token, authToken)                     â”‚   â”‚
â”‚  â”‚  - Handles auth & non-auth requests                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/REST
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Node/Express)                         â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Emergency Controller                              â”‚   â”‚
â”‚  â”‚  GET /r/:token                                          â”‚   â”‚
â”‚  â”‚  - Check token validity                                 â”‚   â”‚
â”‚  â”‚  - Verify auth if provided                              â”‚   â”‚
â”‚  â”‚  - Check role-based access                              â”‚   â”‚
â”‚  â”‚  - Return appropriate data                              â”‚   â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚     â”‚                  â”‚                  â”‚                    â”‚
â”‚  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Token   â”‚  â”‚ Patient      â”‚  â”‚ Audit     â”‚  â”‚ Encryptionâ”‚ â”‚
â”‚  â”‚ Service â”‚  â”‚ Service      â”‚  â”‚ Service   â”‚  â”‚ Service   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚               â”‚                â”‚             â”‚       â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                       â”‚                â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                â”‚
                        â”‚ Database       â”‚ Calls
                        â”‚ Queries        â”‚
                        â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SUPABASE / PostgreSQL Database                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ patients      â”‚  â”‚ allergies    â”‚  â”‚ chronic_       â”‚   â”‚
â”‚  â”‚               â”‚  â”‚              â”‚  â”‚ conditions     â”‚   â”‚
â”‚  â”‚ - id          â”‚  â”‚ - id         â”‚  â”‚                â”‚   â”‚
â”‚  â”‚ - user_id     â”‚  â”‚ - patient_id â”‚  â”‚ - condition    â”‚   â”‚
â”‚  â”‚ - blood_type  â”‚  â”‚ - allergen   â”‚  â”‚ - status       â”‚   â”‚
â”‚  â”‚ - rh_factor   â”‚  â”‚ - severity   â”‚  â”‚ - treatment    â”‚   â”‚
â”‚  â”‚ - public_view â”‚  â”‚ - reaction   â”‚  â”‚                â”‚   â”‚
â”‚  â”‚ - vital_range â”‚  â”‚ - created_at â”‚  â”‚ - created_at   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ medications    â”‚  â”‚ surgeries    â”‚  â”‚ immunizations  â”‚   â”‚
â”‚  â”‚                â”‚  â”‚              â”‚  â”‚                â”‚   â”‚
â”‚  â”‚ - id           â”‚  â”‚ - id         â”‚  â”‚ - id           â”‚   â”‚
â”‚  â”‚ - patient_id   â”‚  â”‚ - patient_id â”‚  â”‚ - patient_id   â”‚   â”‚
â”‚  â”‚ - name         â”‚  â”‚ - name       â”‚  â”‚ - vaccine      â”‚   â”‚
â”‚  â”‚ - dosage       â”‚  â”‚ - date       â”‚  â”‚ - date         â”‚   â”‚
â”‚  â”‚ - frequency    â”‚  â”‚ - surgeon    â”‚  â”‚ - dose         â”‚   â”‚
â”‚  â”‚ - reason       â”‚  â”‚ - hospital   â”‚  â”‚ - booster_due  â”‚   â”‚
â”‚  â”‚ - start_date   â”‚  â”‚              â”‚  â”‚                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ tokens                audit_logs                       â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ - id                 - id                             â”‚ â”‚
â”‚  â”‚ - patient_id         - actor_id                       â”‚ â”‚
â”‚  â”‚ - token              - action                         â”‚ â”‚
â”‚  â”‚ - version            - resource_type                  â”‚ â”‚
â”‚  â”‚ - revoked_at         - timestamp                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

### Public Access (Emergency Responder)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QR Code Scan   â”‚
â”‚  (Token: abc123)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: EmergencyPage  â”‚
â”‚ emergencyAPI.            â”‚
â”‚ getEmergencyView         â”‚
â”‚ (token, no auth)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ HTTP GET /r/abc123
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Emergency Controller    â”‚
â”‚ 1. Validate token               â”‚
â”‚ 2. Is token revoked? âŒ         â”‚
â”‚ 3. No auth provided â†’ public    â”‚
â”‚ 4. Get patient public_view      â”‚
â”‚ 5. Log access                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Queries                 â”‚
â”‚ - Token table (verify)           â”‚
â”‚ - Patient table (public_view)    â”‚
â”‚ - Allergies table (if in view)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
Response:
{
  "public_view": {
    "blood_type": "O",
    "rh_factor": "+",
    "allergies": [...],
    "emergency_contact": {...},
    "last_vitals": {...},
    "vital_ranges": {...}
  },
  "full_data": null,
  "is_authenticated": false
}
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: Render Page            â”‚
â”‚ - Show blood type                â”‚
â”‚ - Show allergies (color coded)   â”‚
â”‚ - Show emergency contact         â”‚
â”‚ - Render VitalMonitor component  â”‚
â”‚ - Display hospitals on map       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Authenticated Access (Doctor/Owner)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logged-in User         â”‚
â”‚  (JWT Token in Session) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Scans QR Code       â”‚
â”‚ (Token: abc123)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: EmergencyPage          â”‚
â”‚ emergencyAPI.                    â”‚
â”‚ getEmergencyView                 â”‚
â”‚ (token, authToken, full=true)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ HTTP GET /r/abc123?full=true
             Authorization: Bearer <JWT>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Emergency Controller        â”‚
â”‚ 1. Validate token                   â”‚
â”‚ 2. Is token revoked? âŒ             â”‚
â”‚ 3. Auth provided â†’ verify JWT       â”‚
â”‚ 4. Get user role from database      â”‚
â”‚ 5. Check authorization:             â”‚
â”‚    - Is Owner? âœ“                    â”‚
â”‚    - Is Doctor? âœ“                   â”‚
â”‚    - Is Admin? âœ“                    â”‚
â”‚ 6. Get full data:                   â”‚
â”‚    - public_view                    â”‚
â”‚    - private_profile (decrypt)      â”‚
â”‚    - chronic_conditions             â”‚
â”‚    - surgeries                      â”‚
â”‚    - medications                    â”‚
â”‚    - immunizations                  â”‚
â”‚ 7. Log access (with user role)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Queries                     â”‚
â”‚ - Token table (verify)               â”‚
â”‚ - User table (get role)              â”‚
â”‚ - Patient table (get all)            â”‚
â”‚ - All medical tables                 â”‚
â”‚ - Encryption service (decrypt)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
Response:
{
  "public_view": { ... },
  "full_data": {
    "patient_id": "...",
    "private_profile": { ... },
    "chronic_conditions": [...],
    "surgeries": [...],
    "medications": [...],
    "immunizations": [...]
  },
  "is_authenticated": true
}
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: Render Page            â”‚
â”‚ - Show all public info           â”‚
â”‚ - PLUS show full medical records â”‚
â”‚ - Display all medications        â”‚
â”‚ - Show surgery history           â”‚
â”‚ - Display conditions             â”‚
â”‚ - Show vaccines                  â”‚
â”‚ - Render VitalMonitor component  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Hierarchy

```
App
â”œâ”€â”€ Routes
â”‚   â”œâ”€â”€ EmergencyPage (Public QR Route)
â”‚   â”‚   â”œâ”€â”€ VitalMonitor (Fixed Sidebar)
â”‚   â”‚   â”‚   â”œâ”€â”€ Header (Collapsible)
â”‚   â”‚   â”‚   â””â”€â”€ VitalCards (Dynamic)
â”‚   â”‚   â”‚       â”œâ”€â”€ HeartRateCard
â”‚   â”‚       â”œâ”€â”€ TemperatureCard
â”‚   â”‚       â”œâ”€â”€ BloodPressureCard
â”‚   â”‚       â”œâ”€â”€ O2SaturationCard
â”‚   â”‚       â””â”€â”€ RespiratoryRateCard
â”‚   â”‚   â”œâ”€â”€ EmergencyHeader
â”‚   â”‚   â”œâ”€â”€ BloodTypeCard
â”‚   â”‚   â”œâ”€â”€ AllergiesCard
â”‚   â”‚   â”œâ”€â”€ EmergencyContactCard
â”‚   â”‚   â”œâ”€â”€ InstructionsCard
â”‚   â”‚   â”œâ”€â”€ VitalsCard
â”‚   â”‚   â”œâ”€â”€ HospitalMap (Leaflet)
â”‚   â”‚   â””â”€â”€ InfoCard
â”‚   â””â”€â”€ ...OtherRoutes
```

---

## Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  patients    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (Primary)   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
       â”‚                          â”‚
       â”‚ user_id                  â”‚
       â”œâ”€ id (PK)                 â”‚
       â”œâ”€ user_id (FK)            â”‚
       â”œâ”€ blood_type              â”‚
       â”œâ”€ rh_factor               â”‚
       â”œâ”€ vital_ranges            â”‚
       â””â”€ ...other fields         â”‚
       â”‚                          â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            â”‚         â”‚        â”‚          â”‚
       â–¼            â–¼         â–¼        â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚allergiesâ”‚ â”‚medicationsâ”‚ â”‚surgeriesâ”‚ â”‚chronic  â”‚ â”‚immunizations
   â”‚        â”‚ â”‚         â”‚ â”‚        â”‚ â”‚conditionsâ”‚ â”‚
   â”‚patient_â”‚ â”‚patient_ â”‚ â”‚patient_â”‚ â”‚patient_  â”‚ â”‚patient_id
   â”‚id (FK) â”‚ â”‚id (FK)  â”‚ â”‚id (FK) â”‚ â”‚id (FK)   â”‚ â”‚(FK)
   â”‚        â”‚ â”‚         â”‚ â”‚        â”‚ â”‚          â”‚ â”‚
   â”‚allergenâ”‚ â”‚name     â”‚ â”‚name    â”‚ â”‚condition â”‚ â”‚vaccine
   â”‚severityâ”‚ â”‚dosage   â”‚ â”‚date    â”‚ â”‚status    â”‚ â”‚date
   â”‚reactionâ”‚ â”‚frequencyâ”‚ â”‚surgeon â”‚ â”‚treatment â”‚ â”‚dose
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Every record has:
- id (UUID Primary Key)
- created_at (Timestamp)
- updated_at (Timestamp with auto-trigger)
- Indexes on patient_id for queries
- Foreign key constraints to patients
- Unique constraints where applicable
```

---

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PUBLIC ACCESS                          â”‚
â”‚  (Emergency Responders - No Authentication)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    Public View
    (Encrypted in transit)
    â”œâ”€ Blood type
    â”œâ”€ RH factor
    â”œâ”€ Allergies
    â”œâ”€ Emergency contact
    â”œâ”€ Medical instructions
    â”œâ”€ Vital ranges
    â””â”€ Last vitals

         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        AUTHENTICATION LAYER (JWT Token)                â”‚
â”‚  Verify user identity before granting access          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        AUTHORIZATION LAYER (Role-Based)                â”‚
â”‚  Check if user can access this specific data          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FULL ACCESS                                â”‚
â”‚  (Doctors, Owners, Admins - Authenticated & Authorized)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    Private Profile (Encrypted in DB)
    â”œâ”€ Full name
    â”œâ”€ Date of birth
    â”œâ”€ National ID
    â”œâ”€ Medical history
    â”œâ”€ Medications (all)
    â”œâ”€ Surgeries
    â”œâ”€ Chronic conditions
    â”œâ”€ Immunizations
    â”œâ”€ Doctor notes
    â””â”€ Scanned files
    
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AUDIT LOGGING                              â”‚
â”‚  All access attempts logged with:                      â”‚
â”‚  - User ID & Role                                      â”‚
â”‚  - Timestamp                                           â”‚
â”‚  - IP Address                                          â”‚
â”‚  - Action (view, update, delete)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Vital Monitor States

```
EXPANDED STATE (User clicks to expand)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¤ï¸ Vital Monitor          â–¼        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ«€ Blood Pressure                  â”‚
â”‚ 120/80 mmHg                        â”‚
â”‚ Normal: 120/80 mmHg                â”‚
â”‚ 15:30                              â”‚
â”‚                                    â”‚
â”‚ â¤ï¸ Heart Rate                      â”‚
â”‚ 72 bpm                             â”‚
â”‚ Normal: 60-100 bpm                 â”‚
â”‚ 15:30                              â”‚
â”‚                                    â”‚
â”‚ ğŸŒ¡ï¸ Temperature                     â”‚
â”‚ 37.0Â°C                             â”‚
â”‚ Normal: 36.1-37.2Â°C                â”‚
â”‚ 15:30                              â”‚
â”‚                                    â”‚
â”‚ ğŸ’¨ Oâ‚‚ Saturation                   â”‚
â”‚ 98%                                â”‚
â”‚ Normal: 95-100%                    â”‚
â”‚ 15:30                              â”‚
â”‚                                    â”‚
â”‚ ğŸ« Respiratory Rate                â”‚
â”‚ 16 breaths/min                     â”‚
â”‚ Normal: 12-20 breaths/min          â”‚
â”‚ 15:30                              â”‚
â”‚                                    â”‚
â”‚ Status Summary:                    â”‚
â”‚ âœ“ HR âœ“ Temp âœ“ BP                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COLLAPSED STATE (User clicks to collapse)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¤ï¸ Vital Monitor          â–²        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+ Shows critical alerts if any âš ï¸
```

---

## API Response Flow

```
Request: GET /r/token123?full=true
         Authorization: Bearer <JWT>

         â”‚
         â–¼ Backend Processing
         
Step 1: Token Validation
        â”œâ”€ Token exists? âœ“
        â”œâ”€ Token not revoked? âœ“
        â””â”€ Token not expired? âœ“
        
Step 2: Authorization Check (if full=true)
        â”œâ”€ Is Owner? âœ“ â†’ Authorized
        â”œâ”€ Is Doctor? âœ“ â†’ Authorized
        â”œâ”€ Is Admin? âœ“ â†’ Authorized
        â””â”€ Other? âœ— â†’ Not Authorized
        
Step 3: Data Retrieval
        â”œâ”€ Patient public_view
        â”œâ”€ Patient private_profile (decrypt)
        â”œâ”€ Chronic conditions
        â”œâ”€ Surgeries
        â”œâ”€ Medications
        â””â”€ Immunizations
        
Step 4: Response Construction
        â””â”€ Status: 200 OK
           Body: {
             public_view: {...},
             full_data: {...},
             is_authenticated: true
           }

Response â†’ Frontend â†’ Render Page
```

---

## Error Handling Flow

```
Request â†’ Validation
          â”‚
          â”œâ”€ Invalid token? â†’ 404 "Invalid or revoked token"
          â”œâ”€ Token revoked? â†’ 404 "Invalid or revoked token"
          â”œâ”€ Patient not found? â†’ 404 "Patient not found"
          â”œâ”€ Invalid JWT? â†’ 401 "Unauthorized"
          â”œâ”€ Not authorized? â†’ 403 "Forbidden"
          â””â”€ Other error? â†’ 500 "Internal error"

Frontend:
â”œâ”€ Show error message to user
â”œâ”€ Log error to console
â””â”€ Suggest action (retry, login, contact support)
```

---

## Component Props Flow

```
EmergencyPage
â””â”€ Receives: { token } from URL
â””â”€ Fetches: emergencyAPI.getEmergencyView()
â””â”€ Creates: vitalData object
â””â”€ Passes to VitalMonitor:
   â”œâ”€ heartRate
   â”œâ”€ temperature
   â”œâ”€ bloodPressureSystolic
   â”œâ”€ bloodPressureDiastolic
   â”œâ”€ oxygenSaturation
   â”œâ”€ respiratoryRate
   â””â”€ onCollapsedChange callback

VitalMonitor
â””â”€ Receives: vital readings
â””â”€ Manages: collapsed state
â””â”€ Renders: Conditional based on props
â””â”€ Colors: Based on vital status
â””â”€ Displays: Normal ranges, timestamp
```

---

This architecture provides:
- **Security**: Multi-layer authentication & authorization
- **Privacy**: Encrypted sensitive data
- **Performance**: Optimized queries with indexes
- **Scalability**: Separate tables for each data type
- **Maintainability**: Clear separation of concerns
- **Auditability**: Complete access logging
